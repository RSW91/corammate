name: Deploy to Google Cloud

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

steps:
- name: Checkout repository
  uses: actions/checkout@v3
  with:
    node-version: 20

- name: Authenticate to Google Cloud
  id: 'auth'
  uses: google-github-actions/auth@v1
  with:
    credentials_json: '${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}'
    node-version: 20

- name: Setup Cloud SDK
  uses: google-github-actions/setup-gcloud@v1
  with:
    project_id: corammate
    install_components: 'gcloud'
    node-version: 20

- name: Deploy to Google Compute Engine
  run: |
    gcloud config set project corammate
    gcloud compute ssh corammate-server --zone asia-northeast3-a --command "cd /home/ryusw91rt/corammate && git pull origin master && npm install && pm2 restart all"
